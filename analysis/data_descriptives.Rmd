---
title: "Descriptives"
author: "Shannon Dickson"
date: "`r format(Sys.Date(), '%B %d %Y')`"
output: 
   bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: false
    code_folding: hide
    theme: paper
---

<style type="text/css">
  
body{ /* Normal  */
  font-size: 12px;
  }
td {  /* Table  */
  font-size: 12px;
}
h1.title {
  font-size: 18px;
  color: DarkBlue;
}
h1 { /* Header 1 */
  font-size: 18px;
}
h2 { /* Header 2 */
  font-size: 18px;
}
h3 { /* Header 3 */
  font-size: 18px;
}
code.r{ /* Code block */
  font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
  font-size: 14px;
}
</style>

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo      = FALSE,
    message   = FALSE,
    warning   = FALSE,
    fig.pos   = "H",
    out.extra = ""
)
```

# Introduction

**Purpose**: Producing some descriptive statistics and visualisations for the thesis.\

**Contributions**: Thanks to Professor Peter Lugtig et al. for providing the original dataset.\

```{r, echo=F}
# Libraries needed:
library(kableExtra)
library(tidyverse)
library(gtsummary)
library(ggnewscale)
library(ggplot2)
library(jcolors)
library(weights)
library(jtools)
library(ggpubr)
library(ggsci)
library(readr)
# My own functions:
source("functions.R")
source("plot_theme.R")
# Data:
data <- readRDS("data/input/data.RDS")
```

# Descriptive Tables

## Table 1. Survey Characteristics

```{r, eval=Fwarning=F}
data %>%
  select(Mode, Topic_Health, Qtype, special_population, Saliency, Incentivised, Reminder, Sponsorship) %>% 
  tbl_summary(by           = Mode,
              sort         = all_categorical() ~ "frequency",
              statistic    = list(all_categorical() ~ "{n} ({p}%)"),
              missing      = "ifany",
              missing_text = "Unknown",
              label        = list(vars(Topic_Health)       ~ "Topic",
                                  vars(Qtype)              ~ "Question type",
                                  vars(special_population) ~ "Special population",
                                  vars(Saliency)           ~ "Saliency of topic",
                                  vars(Incentivised)       ~ "Incentives given ",
                                  vars(Reminder)           ~ "Reminders sent",
                                  vars(Sponsorship)        ~ "Sponsored"
                                  ),
              type        = list(c(Topic_Health, Qtype, special_population, Saliency, Incentivised, Reminder, Sponsorship) ~ "categorical")) %>% 
  
  bold_labels() %>% 
  add_n() %>% 
  modify_header(label ~ "Survey Characteristic") %>% 
  modify_spanning_header(c("stat_1", "stat_2", "stat_3", "stat_4", "stat_5") ~ "**Primary Survey Mode**") %>% 
  modify_table_body(~.x %>% dplyr::mutate(stat_1 = ifelse(stat_1 == 0 | stat_1 == "0 (0%)", "-", stat_1),
                                          stat_2 = ifelse(stat_2 == 0, "-", stat_2),
                                          stat_3 = ifelse(stat_3 == 0, "-", stat_3),
                                          stat_4 = ifelse(stat_4 == 0, "-", stat_4),
                                          stat_5 = ifelse(stat_5 == 0, "-", stat_5))) %>% 
  modify_footnote(everything() ~ NA) %>% 
  as_kable_extra(booktabs = TRUE, longtable = TRUE, linesep = "") %>% 
  kableExtra::kable_classic(position = "left", full_width = F) %>% 
  row_spec(0, bold = TRUE) %>% 
  row_spec(c(4,9,16,20,24,28), italic  = TRUE)
  #footnote(general_title = "Statistics:",
           #general       = "<i>% (n)</i>", escape = FALSE)
```

## Table 2. NR and NRB in Groves and Peytcheva (2008) vs New Studies and by Mode

```{r}
# NR and Bias by Studies
t_groves <- data %>% 
              mutate(Groves = recode(Groves, "1" = "Groves",
                                             "0" = "New studies")) %>% 
              drop_na(Groves)  %>% 
              group_by(Groves) %>% 
              rename("Characteristic" = "Groves") %>% 
              summarise("Nonresponse Rate"       = mean(MN, na.rm=TRUE),
                        "Absolute Relative Bias" = mean(AbsRelbias, na.rm=TRUE),
                        "N"                      = n()) %>% 
             arrange(desc(N))

saveRDS(t_groves, "tables/t_groves.RDS")

# NR and Bias by Modes
t_modes <- data %>% 
             drop_na(Mode)  %>% 
             group_by(Mode) %>% 
             rename("Characteristic" = "Mode") %>% 
             summarise("Nonresponse Rate"       = mean(MN, na.rm=TRUE),
                       "Absolute Relative Bias" = mean(AbsRelbias, na.rm=TRUE),
                       "N"                      = n()) %>% 
             arrange(desc(N))

saveRDS(t_modes, "tables/t_modes.RDS")

# Combine both tables
t_groves_modes <- rbind(t_groves, t_modes)

# Save the tables
saveRDS(t_groves, "tables/t_groves.RDS")
saveRDS(t_modes, "tables/t_modes.RDS")
saveRDS(t_groves_modes, "tables/t_groves_modes.RDS")
```

## Table 3. NR and NRB by Country

```{r}
t_country <- data %>% 
               drop_na(Country) %>% 
               group_by(Country) %>% 
               summarise("Nonresponse Rate"       = mean(MN, na.rm=TRUE),
                         "Absolute Relative Bias" = mean(AbsRelbias, na.rm=TRUE),
                         "N"                      = n()) %>% 
               arrange(desc(N))

saveRDS(t_country, "tables/t_country.RDS")
```

## Table 4. NR and NRB by Information Source on Nonrespondents

```{r}
t_source <- data %>% 
              drop_na(Source) %>% 
              group_by(Source) %>% 
              summarise("Nonresponse Rate"       = mean(MN, na.rm=TRUE),
                        "Absolute Relative Bias" = mean(AbsRelbias, na.rm=TRUE),
                        "N"                      = n()) %>% 
              arrange(desc(N))

saveRDS(t_source, "tables/t_source.RDS")

t_source %>% 
  kbl(digits   = 2,
      align    = c("l", "c", "c"),
      booktabs = T,
      linesep  = "",
      caption  = "Nonresponse rates and absolute relative bias by source") %>% 
  kable_classic(position      = "left",
                latex_options = "HOLD_position",
                full_width    = F) %>% 
  column_spec(c(1, 2, 3), width = "12em") %>% 
  column_spec(1, bold = T) %>% 
  row_spec(0, bold = T) %>% 
  footnote(general = "Nonresponse rate and absolute relative bias are expressed as a percentage.") 
```

# Descriptive Figure

## Figure 1. Weighted Correlation of NR and NRB

```{r}
data %>% 
        ggplot(aes(MN, AbsRelbias, colour = Groves)) +
        geom_jitter(data = filter(data, Groves == 0), alpha = 0.3,   size = 2, shape = 19) +
        geom_jitter(data = filter(data, Groves == 1), alpha = 0.5,   size = 3, shape = 18) +
        geom_smooth(data = filter(data, Groves == 0), method = "lm", color = "darkblue", linetype = "dashed", lwd = 0.7, se = F) +
        geom_smooth(data = filter(data, Groves == 1), method = "lm", color = "orange3", linetype = "solid", lwd = 0.7, se = F) +
  
        scale_y_continuous(expand  = c(0, 0), limits = c(-2, 100)) +
        scale_x_continuous(expand  = c(0, 2), limits = c(0, 100)) +
  
        #scale_fill_manual(values = c("#386cb0", "#fec66b")) +
        scale_colour_manual(values = c("#386cb0", "#fec66b"),
                            name = "",
                            labels = c("New studies", "Groves and Peytcehva (2008)")) +

        labs(x     = "Nonresponse Rate (%)",
             y     = "Nonresponse Bias (%)") +
  
        theme_thesis() +
        theme(
              legend.position   = "top",
              legend.background = element_rect(fill = 'transparent', color = NA),
              panel.background  = element_rect(fill = 'transparent', color = NA), 
              plot.background   = element_rect(fill = 'transparent', color = NA))
```

```{r, warning=F}
p1 <- data %>% 
        ggplot(aes(MN, AbsRelbias, colour = Groves)) +
        geom_jitter(data = filter(data, Groves == 0), alpha = 0.3,   size = 2, shape = 19) +
        geom_jitter(data = filter(data, Groves == 1), alpha = 0.5,   size = 3, shape = 18) +
        geom_smooth(data = filter(data, Groves == 0), method = "lm", color = "darkblue", linetype = "dashed", lwd = 1.2, se = F) +
        geom_smooth(data = filter(data, Groves == 1), method = "lm", color = "orange3", linetype = "solid", lwd = 1, se = F) +
  
        scale_y_continuous(expand  = c(0, 0), limits = c(-2, 100)) +
        scale_x_continuous(expand  = c(0, 2), limits = c(0, 100)) +
  
        scale_colour_manual(values = c("#386cb0", "#fec66b"),
                            name = "",
                            labels = c("New studies", "Groves and Peytcehva (2008)")) +

        labs(x     = "Nonresponse Rate (%)",
             y     = "Nonresponse Bias (%)") +
  
        theme_thesis() +
        theme(
              legend.position   = "top",
              legend.background = element_rect(fill = 'transparent', color = NA),
              panel.background  = element_rect(fill = 'transparent', color = NA), 
              plot.background   = element_rect(fill = 'transparent', color = NA))

ggsave('img/descriptive_plots/p_within.pdf', p1, bg = 'transparent')

p2 <- data %>% 
        ggplot(aes(MN, meanNRbias, colour = Groves)) + 
        geom_jitter(data = filter(data, Groves == 0), alpha = 0.3,   size = 2, shape = 19) +
        geom_jitter(data = filter(data, Groves == 1), alpha = 0.3,   size = 3, shape = 18) +
        geom_smooth(data = filter(data, Groves == 0), method = "lm", color = "darkblue", linetype = "dashed", lwd = 1.2, se = F) +
        geom_smooth(data = filter(data, Groves == 1), method = "lm", color = "orange3", linetype = "solid", lwd = 1, se = F) +
  
        scale_y_continuous(expand  = c(0, 0), limits = c(-2, 100)) +
        scale_x_continuous(expand  = c(0, 2), limits = c(0, 100)) +
  
        scale_colour_manual(values = c("#386cb0", "#fec66b"),
                            name = "",
                            labels = c("New studies", "Groves and Peytcehva (2008)")) +

        labs(x     = "Nonresponse Rate (%)",
             y     = "Mean Nonresponse Bias (%)") +
  
        theme_thesis() +
        theme(
              legend.position   = "top",
              legend.background = element_rect(fill = 'transparent', color = NA),
              panel.background  = element_rect(fill = 'transparent', color = NA), 
              plot.background   = element_rect(fill = 'transparent', color = NA))

ggsave('img/descriptive_plots/p_between.pdf', p2, bg = 'transparent')

p_within_between <- ggarrange(p1, p2, ncol = 2, legend = "top", common.legend = TRUE)

ggsave('img/descriptive_plots/p_within_between.pdf', p_within_between, bg = 'transparent', width = 10, height = 5)
```

## Figure 1. Yearly Change in NR and NRB 

```{r, warning=F}
p3 <- data %>% 
        ggplot(aes(Year, MN, colour = Groves)) +
        geom_point(data = filter(data, Groves == 0), alpha = 0.3,   size = 2, shape = 19) +
        geom_point(data = filter(data, Groves == 1), alpha = 0.3,   size = 3, shape = 18) +
        geom_smooth(data = filter(data, Groves == 0), method = "lm", color = "darkblue", linetype = "dashed", lwd = 1.2, se = F) +
        geom_smooth(data = filter(data, Groves == 1), method = "lm", color = "orange3", linetype = "solid", lwd = 1, se = F) +
        scale_colour_manual(values = c("#386cb0", "#fec66b"),
                            name = "",
                            labels = c("New studies", "Groves and Peytcehva (2008)")) +

        labs(x     = "Year",
             y     = "Nonresponse Rate (%)") +
  
        theme_thesis() +
        theme(
              legend.position   = "top",
              legend.background = element_rect(fill = 'transparent', color = NA),
              panel.background  = element_rect(fill = 'transparent', color = NA), 
              plot.background   = element_rect(fill = 'transparent', color = NA))

ggsave('img/descriptive_plots/p_nr_year.pdf', p3, bg = 'transparent')

p4 <- data %>% 
       ggplot(aes(Year, AbsRelbias, colour = Groves)) +
        geom_point(data = filter(data, Groves == 0), alpha = 0.3,   size = 2, shape = 19) +
        geom_point(data = filter(data, Groves == 1), alpha = 0.3,   size = 3, shape = 18) +
        geom_smooth(data = filter(data, Groves == 0), method = "lm", color = "darkblue", linetype = "dashed", lwd = 1.2, se = F) +
        geom_smooth(data = filter(data, Groves == 1), method = "lm", color = "orange3", linetype = "solid", lwd = 1, se = F) +
  
        #scale_colour_manual(values = c("#386cb0", "#fec66b")) +
        scale_colour_manual(values = c("#386cb0", "#fec66b"),
                            name = "",
                            labels = c("New studies", "Groves and Peytcehva (2008)")) +

        labs(x     = "Year",
             y     = "Nonresponse Bias (%)") +
  
        theme_thesis() +
        theme(
              legend.position   = "top",
              legend.background = element_rect(fill = 'transparent', color = NA),
              panel.background  = element_rect(fill = 'transparent', color = NA), 
              plot.background   = element_rect(fill = 'transparent', color = NA))


ggsave('img/descriptive_plots/p_nrb_year.pdf', p4, bg = 'transparent')

p_year <- ggarrange(p3, p4, ncol = 2, legend = "top", common.legend = TRUE) 

ggsave('img/descriptive_plots/p_year.png', p_year, bg='transparent', width = 10, height = 5)

p_everthing <- ggarrange(p1, p2, p3, p4, 
                        ncol   = 2,
                        nrow   = 2,
                        labels = c("A", "B", "C", "D"), 
                        legend = "bottom",
                        common.legend = TRUE)
  
ggsave('img/descriptive_plots/p_everthing.pdf', p_everthing, bg='transparent', width = 10, height = 10)
```

## Figure 2. Distribution of NR and NRB by Survey Mode

```{r}
p5 <- data %>% 
        drop_na(Mode) %>% 
        ggplot(aes(x = Mode, y = MN)) +
        geom_violin(aes(fill = Mode), alpha = 0.8) +
        stat_summary(fun.data=data_summary, alpha = 0.6) +
        labs(x = "", y = "Nonresponse Rate (%)") +
        scale_y_continuous(expand = c(0, 0), limits = c(-5, 100)) +
        scale_fill_thesis() +
        scale_colour_thesis() +
        #scale_fill_jcolors(palette  = "pal9") +
        #scale_color_jcolors(palette = "pal9") +
        theme_thesis() +
        theme(
              panel.background      = element_rect(fill = 'transparent', color = NA), 
              plot.background       = element_rect(fill = 'transparent', color = NA), 
              legend.position       = "none",
              legend.background     = element_rect(fill = 'transparent')) +
        guides(color = guide_legend(override.aes = list(size = 3)))

ggsave('img/descriptive_plots/p_nr_dist.pdf', p5, bg ='transparent')

p6 <- data %>% 
        drop_na(Mode) %>% 
        ggplot(aes(x = Mode, y = AbsRelbias)) +
        geom_violin(aes(fill = Mode), alpha = 0.9) +
        stat_summary(fun.data = data_summary, alpha = 0.6) +
        labs(x = "", y = "Nonresponse Bias (%)") +
        scale_y_continuous(expand  = c(0, 0), limits = c(-5, 100)) +
       scale_fill_thesis() +
        scale_colour_thesis() +
        #scale_fill_jcolors(palette  = "pal9") +
        #scale_color_jcolors(palette = "pal9") +
        theme_thesis() +
        theme(
              panel.background      = element_rect(fill = 'transparent', color = NA), 
              plot.background       = element_rect(fill = 'transparent', color = NA), 
              legend.position       = "none",
              legend.background     = element_rect(fill = 'transparent')) +
        guides(color = guide_legend(override.aes = list(size = 3)))

ggsave('img/descriptive_plots/p_bias_dist.png', p6, bg ='transparent')

p_dists <- ggarrange(p5, p6, ncol = 1, labels = c("A", "B"), legend = "none") %>%
           annotate_figure(bottom = text_grob("Primary Survey Mode", face = "bold", size = 14))

ggsave('img/descriptive_plots/p_dists.pdf', p_dists, bg ='transparent', height = 10, width = 10)
```


`

